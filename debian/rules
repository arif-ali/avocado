#!/usr/bin/make -f
export PYBUILD_NAME=avocado
export PYBUILD_INSTALL_ARGS=--install-layout=deb
export PY_SITEBUILD=/usr/lib/python3/dist-packages

%:
	dh $@ --with python3 --buildsystem=pybuild

override_dh_auto_test:
ifeq (,$(filter nocheck,$(DEB_BUILD_OPTIONS)))
	mkdir -p build/etc/avocado/
	cp examples/config/avocado-tests.conf build/etc/avocado/avocado.conf
	VIRTUAL_ENV="build/" python3 setup.py test --select=unit
endif

override_dh_installman:
	python3 setup.py man
	dh_installman

override_dh_link:
	jdupes -rl debian/${PYBUILD_NAME}/usr
	dh_link

override_dh_clean:
	rm -rf avocado/build
	dh_clean

override_dh_install:
	dh_install
	mkdir -p debian/${PYBUILD_NAME}/usr/libexec
	mv debian/${PYBUILD_NAME}/usr/bin/avocado-runner-* debian/${PYBUILD_NAME}/usr/libexec

override_dh_python3:
	dh_python3
	mkdir -p debian/${PYBUILD_NAME}/usr/libexec/avocado
	mv debian/${PYBUILD_NAME}${PY_SITEBUILD}/avocado/etc debian/${PYBUILD_NAME}/
	mv debian/${PYBUILD_NAME}${PY_SITEBUILD}/avocado/libexec/* debian/${PYBUILD_NAME}/usr/libexec/avocado
	rmdir debian/${PYBUILD_NAME}${PY_SITEBUILD}/avocado/libexec
